<?php
session_start();

$current_partner=$_SESSION['partner'];

 $conn = new Mongo('localhost');
 $db = $conn->payback;
 $coll_partner = $db->partner;
 $cursor_partner = $coll_partner->find(); 

 print_r($_POST);


//**********************************************************ADD PRODUCT GROUP
 if($_POST['dusra']=="addgroup")
{
	$qu=array("partnername"=> $current_partner);
	$nw=array("product_group"=>$_POST['product_group'],"p_details"=>array());
	$x=$coll_partner->update($qu,array('$addToSet'=>array("products" => $nw)));
	var_dump($x);
        header("Location: /postadmin.php");
}
//**********************************************************


 else if($_POST['dusra'] == "add")
 {
    $new_id=strtolower(substr($_POST['product_group'],0,3).substr($_POST['name'],0,3).$_POST['id']);
    if($_POST['acc']){
    $new_id=$new_id."acc";
    }
    $new_name=$_POST['name']." ".$_POST['id'];
    $qu=array("partnername" => $current_partner,"products.product_group" => $_POST['product_group']);
    $nw=array("name" => $new_name,"id" => $new_id, "price" => intval($_POST['price']));
    $x=$coll_partner->update($qu,array('$addToSet' => array("products.$.p_details"=>$nw)));
    var_dump($x);
        header("Location: /postadmin.php");
 }
else if($_POST['dusra'] == "delete")
 {
    $qu=array("partnername" => $current_partner,"products.product_group" => $_POST['product_group']);
    $nw=array("id" => $_POST['id']);
    $x=$coll_partner->update($qu,array('$pull' => array("products.$.p_details"=>$nw)));
    header("Location: /postadmin.php");
  }

//************************************************REMOVE PRODUCT GROUP
 else if($_POST['dusra'] == "remove")
 {

    $x=$coll_partner->update(array("partnername"=>$current_partner),array('$pull' => array("products" =>array("product_group" =>$_POST['product_group']))));
    header("Location: /postadmin.php");
    print_r($x);
  }
//****************************************************************

 else  if($_POST['dusra'] == "update")
 {
 	foreach($cursor_partner as $obj)
    {

    if($obj['partnername']==$current_partner)
    {
        foreach($obj['products'] as $obj_pro)
        {
            
            if($obj_pro['product_group']==$_POST['product_group'])
            {
            $count=0;
        	foreach($obj_pro[p_details] as $obj_details)           
            {
                    
                    
                    if($obj_details['id'] ==$_POST['id'])
                    {

                        $flag=1;
                    	break;
                    }
                    $count+=1;	

            }
             if($flag=1)
                    {
                        break;
                    }
            }
        }
    }
}
$qu=array("partnername" => $current_partner,"products.p_details.id" => $_POST['id']);
$nw=array("products.$.p_details.{$count}.name" => $_POST['name'],
 "products.$.p_details.{$count}.id" => $_POST['id'], "products.$.p_details.{$count}.price" => intval($_POST['price']));
$coll_partner->update($qu,array('$set'=>$nw));
header("Location: /postadmin.php");
 }
	

?>
